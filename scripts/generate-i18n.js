const fs = require('fs');
const path = require('path');

/**
 * –°–∫—Ä–∏–ø—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–∏–ø–æ–≤ –¥–ª—è i18n
 */
function generateI18nTypes() {
  console.log('üöÄ Generating i18n types...');

  const localesPath = path.join(process.cwd(), 'src', 'core', 'i18n', 'locales');
  const outputPath = path.join(
    process.cwd(),
    'src',
    'core',
    'i18n',
    'generated',
    'i18n.generated.ts',
  );

  // –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É generated –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
  const generatedDir = path.dirname(outputPath);
  if (!fs.existsSync(generatedDir)) {
    fs.mkdirSync(generatedDir, { recursive: true });
    console.log(`üìÅ Created directory: ${generatedDir}`);
  }

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ø–∞–ø–∫–∏ —Å –ø–µ—Ä–µ–≤–æ–¥–∞–º–∏
  if (!fs.existsSync(localesPath)) {
    console.error('‚ùå Locales directory not found:', localesPath);
    process.exit(1);
  }

  // –ß–∏—Ç–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É JSON —Ñ–∞–π–ª–æ–≤ –∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ç–∏–ø—ã
  const enPath = path.join(localesPath, 'en');

  if (!fs.existsSync(enPath)) {
    console.error('‚ùå English locales directory not found:', enPath);
    process.exit(1);
  }

  const namespaceFiles = fs.readdirSync(enPath).filter((file) => file.endsWith('.json'));

  if (namespaceFiles.length === 0) {
    console.error('‚ùå No JSON translation files found in:', enPath);
    process.exit(1);
  }

  console.log(`üìù Found namespaces: ${namespaceFiles.join(', ')}`);

  let typesContent = `/* DO NOT EDIT, file generated by custom script */
import { Path } from "nestjs-i18n";

export type I18nTranslations = {\n`;

  for (const namespaceFile of namespaceFiles) {
    const namespace = namespaceFile.replace('.json', '');
    const filePath = path.join(enPath, namespaceFile);

    try {
      const content = JSON.parse(fs.readFileSync(filePath, 'utf8'));
      typesContent += `  ${namespace}: ${generateInterface(content, 2)};\n`;
      console.log(`‚úÖ Processed namespace: ${namespace}`);
    } catch (error) {
      console.error(`‚ùå Error processing ${namespaceFile}:`, error.message);
      process.exit(1);
    }
  }

  typesContent += `};\n\n`;

  // === –î–û–ë–ê–í–õ–ï–ù–û: –≥–µ–Ω–µ—Ä–∞—Ü–∏—è I18N_NAMESPACES ===
  const namespaceNames = namespaceFiles.map((file) => file.replace('.json', ''));
  typesContent += `export const I18N_NAMESPACES = [\n`;
  namespaceNames.forEach((ns) => {
    typesContent += `  '${ns}',\n`;
  });
  typesContent += `] as const;\n\n`;

  typesContent += `export type I18nNamespace = typeof I18N_NAMESPACES[number];\n\n`;
  // === –ö–û–ù–ï–¶ –î–û–ë–ê–í–õ–ï–ù–ò–Ø ===

  typesContent += `export type I18nPath = Path<I18nTranslations>;\n`;

  fs.writeFileSync(outputPath, typesContent);
  console.log('‚úÖ i18n types generated successfully!');
  console.log(`üìÑ Output file: ${outputPath}`);
}

function generateInterface(obj, indent) {
  const spaces = ' '.repeat(indent);
  let result = '{\n';

  for (const [key, value] of Object.entries(obj)) {
    if (typeof value === 'object' && value !== null && !Array.isArray(value)) {
      result += `${spaces}  ${key}: ${generateInterface(value, indent + 2)},\n`;
    } else {
      result += `${spaces}  ${key}: string;\n`;
    }
  }

  result += `${spaces}}`;
  return result;
}

// –ó–∞–ø—É—Å–∫–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
generateI18nTypes();
